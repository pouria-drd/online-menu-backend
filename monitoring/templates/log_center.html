{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<style>
  .log-toolbar {
    display: flex;
    flex-wrap: wrap; /* Allow items to wrap on smaller screens */
    gap: 12px;
    align-items: center;
    margin: 16px 0;
  }
  .log-badge {
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap; /* Prevent badge text from wrapping */
  }
  .lvl-DEBUG { background: #e9f9ee; color: #1a7f37; }
  .lvl-INFO { background: #cce5ff; color: #004085; }
  .lvl-WARNING { background: #fff7e6; color: #ad6800; }
  .lvl-ERROR { background: #ffe6e6; color: #a8071a; }
  .lvl-CRITICAL { background: #ffe6f1; color: #c41d7f; }
  .log-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* Allow table to adjust column widths */
  }
  .log-table th, .log-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
    vertical-align: top;
    text-align: left; /* Ensure consistent text alignment */
  }
  .log-table th {
    font-weight: 600;
    color: #555;
  }
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    word-break: break-all; /* Break long words for better wrapping */
  }
  .log-toolbar label {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1 1 auto; /* Allow inputs to grow/shrink */
  }
  .log-toolbar select, .log-toolbar input[type="number"] {
    width: 100%;
    max-width: 150px; /* Limit max width for inputs */
    padding: 4px;
    font-size: 0.9rem;
  }
  .log-toolbar .button {
    padding: 6px 12px;
    font-size: 0.9rem;
    white-space: nowrap;
    text-align: center;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .log-toolbar {
      flex-direction: column; /* Stack toolbar items vertically */
      align-items: stretch;
    }
    .log-toolbar label {
      flex-direction: column; /* Stack label and input */
      align-items: flex-start;
    }
    .log-toolbar select, .log-toolbar input[type="number"] {
      max-width: 100%; /* Full width for inputs on mobile */
    }
    .log-table th, .log-table td {
      padding: 6px 8px; /* Reduce padding for smaller screens */
      font-size: 0.85rem; /* Slightly smaller font */
    }
    .log-table th:nth-child(3), .log-table td:nth-child(3) {
      display: none; /* Hide Logger column on small screens */
    }
    .log-table th:nth-child(1), .log-table td:nth-child(1) {
      width: 30%; /* Adjust Time column width */
    }
    .log-table th:nth-child(2), .log-table td:nth-child(2) {
      width: 20%; /* Adjust Level column width */
    }
  }

  @media (max-width: 480px) {
    .log-table {
      display: block; /* Convert table to block for stacking */
    }
    .log-table thead {
      display: none; /* Hide table headers */
    }
    .log-table tbody, .log-table tr {
      display: block;
    }
    .log-table td {
      display: block;
      text-align: left;
      padding: 8px;
      border-bottom: none;
      position: relative;
    }
    .log-table td:before {
      content: attr(data-label); /* Use data-label for mobile view */
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }
    .log-table td:nth-child(1) { order: 1; } /* Time */
    .log-table td:nth-child(2) { order: 2; } /* Level */
    .log-table td:nth-child(3) { display: none; } /* Logger */
    .log-table td:nth-child(4) { order: 3; } /* Message */
  }
</style>

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='monitoring' %}">Monitoring</a>
    &rsaquo; <a href="{% url 'admin:monitoring_logcentermodel_changelist' %}">Log Center</a>

</div>
{% endblock %}

<form method="get" class="log-toolbar">
  <label>
    App:
    <select name="app" onchange="this.form.submit()">
      {% for app, p in apps %}
        <option value="{{ app }}" {% if app == selected_app %}selected{% endif %}>{{ app }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    File:
    <select name="file" onchange="this.form.submit()">
      {% for f in files %}
        <option value="{{ f }}" {% if f == selected_file %}selected{% endif %}>{{ f }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    Lines:
    <input type="number" name="n" value="{{ n }}" min="50" max="5000" step="50" />
  </label>

  <label>
    Level:
    <select name="level">
      {% for lvl in levels %}
        <option value="{{ lvl }}" {% if lvl == request.GET.level %}selected{% endif %}>{{ lvl|default:"(all)" }}</option>
      {% endfor %}
    </select>
  </label>

  <button class="button" type="submit">Apply</button>

  {% if selected_app and selected_file %}
    <a class="button" href="{% url 'admin:monitoring-log-download' %}?app={{ selected_app }}&file={{ selected_file }}">Download</a>
  {% endif %}
</form>

{% if rows %}
  <table class="log-table">
    <thead>
      <tr>
        <th data-label="Time">Time</th>
        <th data-label="Level">Level</th>
        <th data-label="Logger">Logger</th>
        <th data-label="Message">Message</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td data-label="Time" class="mono">{{ r.time }}</td>
        <td data-label="Level"><span class="log-badge lvl-{{ r.level|default:'INFO' }}">{{ r.level|default:"INFO" }}</span></td>
        <td data-label="Logger" class="mono">{{ r.name }}</td>
        <td data-label="Message" class="mono">{{ r.message }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No logs found for this selection.</p>
{% endif %}
{% endblock %}